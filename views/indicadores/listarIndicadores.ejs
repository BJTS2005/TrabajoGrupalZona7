<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Indicadores</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Indicadores de la Categoría: <%= categoria.cat_nombre %>
        </h1>

        <!-- Botón para volver a la gestión de categorías -->
        <div class="text-end mb-3">
            <a href="/categorias" class="btn btn-secondary">Volver a Gestión de Categorías</a>
        </div>

        <!-- Botón para abrir el modal de registrar -->
        <div class="text-end mb-3">
            <button type="button" class="btn btn-success" data-bs-toggle="modal"
                data-bs-target="#modalRegistrarIndicador">
                Registrar Nuevo Indicador
            </button>
        </div>

        <!-- Tabla de indicadores -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-primary">
                    <tr>
                        <th>Código</th>
                        <th>Criterio</th>
                        <th>Puntos</th>
                        <th>Responsable</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% indicadores.forEach(indicador=> { %>
                        <tr>
                            <td>
                                <%= indicador.ind_cod %>
                            </td>
                            <td class="text-wrap">
                                <%= indicador.ind_nombre %>
                            </td>
                            <td>
                                <%= indicador.ind_puntos %>
                            </td>
                            <td>
                                <%= indicador.MiembroUnidad.mie_nombres %>
                                    <%= indicador.MiembroUnidad.mie_apellidos %>
                            </td>
                            <td>
                                <!-- Botón para abrir el modal de editar -->
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#modalEditarIndicador" data-cod="<%= indicador.ind_cod %>"
                                    data-nombre="<%= indicador.ind_nombre %>" data-puntos="<%= indicador.ind_puntos %>"
                                    data-mie_ci="<%= indicador.mie_ci %>">
                                    Editar
                                </button>
                                <!-- Botón de eliminar -->
                                <form action="/indicadores/eliminar/<%= categoria.cat_cod %>/<%= indicador.ind_cod %>"
                                    method="POST" class="d-inline"
                                    onsubmit="return confirm('¿Estás seguro de eliminar este indicador?');">
                                    <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                </form>

                                <!-- Botón para abrir el modal de gestión de rangos -->
                                <button class="btn btn-info btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#modalGestionarRangos" data-ind_cod="<%= indicador.ind_cod %>"
                                    data-ind_nombre="<%= indicador.ind_nombre %>"
                                    data-cat_cod="<%= indicador.cat_cod %>">Gestionar Rangos</button>
                            </td>
                        </tr>
                        <% }); %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para registrar indicador -->
    <div class="modal fade" id="modalRegistrarIndicador" tabindex="-1" aria-labelledby="modalRegistrarIndicadorLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRegistrarIndicadorLabel">Registrar Indicador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/indicadores/registrar" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="cat_cod" value="<%= categoria.cat_cod %>">
                        <div class="mb-3">
                            <label for="ind_cod" class="form-label">Código</label>
                            <input type="text" class="form-control" id="ind_cod" name="ind_cod" maxlength="10" required>
                        </div>
                        <div class="mb-3">
                            <label for="ind_nombre" class="form-label">Criterio</label>
                            <textarea class="form-control" id="ind_nombre" name="ind_nombre" rows="3"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="ind_puntos" class="form-label">Puntos</label>
                            <input type="number" class="form-control" id="ind_puntos" name="ind_puntos" required>
                        </div>
                        <div class="mb-3">
                            <label for="mie_ci" class="form-label">Responsable</label>
                            <select id="mie_ci" name="mie_ci" class="form-select" required>
                                <% miembros.forEach(miembro=> { %>
                                    <option value="<%= miembro.mie_ci %>">
                                        <%= miembro.mie_nombres %>
                                            <%= miembro.mie_apellidos %>
                                    </option>
                                    <% }); %>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Registrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar indicador -->
    <div class="modal fade" id="modalEditarIndicador" tabindex="-1" aria-labelledby="modalEditarIndicadorLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarIndicadorLabel">Editar Indicador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/indicadores/editar" method="POST">
                    <div class="modal-body">
                        <input type="hidden" id="ind_cod_editar" name="ind_cod">
                        <div class="mb-3">
                            <label for="ind_nombre_editar" class="form-label">Criterio</label>
                            <textarea class="form-control" id="ind_nombre_editar" name="ind_nombre" rows="3"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="ind_puntos_editar" class="form-label">Puntos</label>
                            <input type="number" class="form-control" id="ind_puntos_editar" name="ind_puntos" required>
                        </div>
                        <div class="mb-3">
                            <label for="mie_ci_editar" class="form-label">Responsable</label>
                            <select id="mie_ci_editar" name="mie_ci" class="form-select" required>
                                <% miembros.forEach(miembro=> { %>
                                    <option value="<%= miembro.mie_ci %>">
                                        <%= miembro.mie_nombres %>
                                            <%= miembro.mie_apellidos %>
                                    </option>
                                    <% }); %>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Gestionar Rangos -->
    <div class="modal fade" id="modalGestionarRangos" tabindex="-1" aria-labelledby="modalGestionarRangosLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalGestionarRangosLabel">Gestionar Rangos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario de Registro de Rango -->
                    <form id="formRegistrarRango">
                        <input type="text" id="ind_cod_rango" name="ind_cod">
                        <input type="text" id="cat_cod_rango" name="cat_cod">
                        <div class="mb-3">
                            <label for="descripcion_ran" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion_ran" name="descripcion_ran"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="valor_ran" class="form-label">Valor</label>
                            <input type="number" class="form-control" id="valor_ran" name="valor_ran" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="esta_seleccionado"
                                name="esta_seleccionado">
                            <label class="form-check-label" for="esta_seleccionado">Seleccionar como rango
                                actual</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar Rango</button>
                    </form>

                    <!-- Tabla de Rangos Existentes -->
                    <h5 class="mt-4">Rangos Existentes</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Valor</th>
                                <th>Seleccionado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-rangos">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>





    <script>
        const modalEditar = document.getElementById('modalEditarIndicador');
        modalEditar.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const cod = button.getAttribute('data-cod');
            const nombre = button.getAttribute('data-nombre');
            const puntos = button.getAttribute('data-puntos');
            const mie_ci = button.getAttribute('data-mie_ci');

            modalEditar.querySelector('#ind_cod_editar').value = cod;
            modalEditar.querySelector('#ind_nombre_editar').value = nombre;
            modalEditar.querySelector('#ind_puntos_editar').value = puntos;
            modalEditar.querySelector('#mie_ci_editar').value = mie_ci;
        });


        const modalGestionarRangos = document.getElementById("modalGestionarRangos");
        modalGestionarRangos.addEventListener("show.bs.modal", (event) => {
            const button = event.relatedTarget;
            const ind_cod = button.getAttribute("data-ind_cod");
            const ind_nombre = button.getAttribute("data-ind_nombre");
            const cat_cod = button.getAttribute("data-cat_cod");

            document.getElementById("modalGestionarRangosLabel").innerText = `Gestionar Rangos para ${ind_nombre}`;
            document.getElementById("ind_cod_rango").value = ind_cod;
            document.getElementById("cat_cod_rango").value = cat_cod;

            const tablaRangos = document.getElementById("tabla-rangos");
            tablaRangos.innerHTML = "";

            fetch(`/indicadores/rangos/listar/${ind_cod}`)
                .then((response) => response.json())
                .then((data) => {
                    data.forEach((rango) => {
                        const fila = document.createElement("tr");

                        fila.innerHTML = `
                    <td>${rango.descripcion_ran}</td>
                    <td>${rango.valor_ran + '%'} </td> 
                    <td>${rango.esta_seleccionado ? "Sí" : "No"}</td>
                    <td>
                        <form action="/rangos/eliminar/${rango.id_ran}" method="POST" class="d-inline" onsubmit="return confirm('¿Estás seguro de eliminar este rango?');">
                            <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                        </form>
                        <button class="btn btn-warning btn-sm" onclick="editarRango(${rango.id_ran}, '${rango.descripcion_ran}', ${rango.valor_ran}, ${rango.esta_seleccionado}, '${ind_cod}')">Editar</button>
                        ${!rango.esta_seleccionado ? `<form action="/rangos/seleccionar/${rango.id_ran}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-info btn-sm">Seleccionar</button>
                        </form>` : ""}
                    </td>
                `;

                        tablaRangos.appendChild(fila);
                    });
                })
                .catch((error) => {
                    console.error("Error al cargar los rangos:", error);
                });
        });

        document.getElementById('formRegistrarRango').addEventListener('submit', function (event) {
            event.preventDefault(); 
         
            const data = {
                ind_cod: document.getElementById('ind_cod_rango').value,
                //cat_cod: document.getElementById('cat_cod_rango').value,             
                descripcion_ran: document.getElementById('descripcion_ran').value,
                valor_ran: parseFloat(document.getElementById('valor_ran').value),
                esta_seleccionado: document.getElementById('esta_seleccionado').checked, 
            };

            //console.log(data); 

            fetch('/indicadores/rangos/registrar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', 
                },
                body: JSON.stringify(data), 
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                      
                        const tablaRangos = document.getElementById('tabla-rangos');
                        const nuevoRango = data.rango;

                        const nuevaFila = document.createElement('tr');
                        nuevaFila.innerHTML = `
                    <td>${nuevoRango.descripcion_ran}</td>
                    <td>${nuevoRango.valor_ran}</td>
                    <td>${nuevoRango.esta_seleccionado ? "Sí" : "No"}</td>
                    <td>
                        <!-- Aquí puedes agregar botones de editar o eliminar -->
                    </td>
                `;
                        tablaRangos.appendChild(nuevaFila);

                        document.getElementById('descripcion_ran').value = '';
                        document.getElementById('valor_ran').value = '';
                        document.getElementById('esta_seleccionado').checked = false;
                    } else {
                        alert("Error al registrar el rango.");
                    }
                })
                .catch(error => console.error("Error:", error));
        });



    </script>
</body>

</html>