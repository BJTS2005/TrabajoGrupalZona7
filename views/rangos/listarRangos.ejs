<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <!-- Título de la página -->
        <h1 class="text-center mb-4">
            <%= title %>
        </h1>

        <!-- Botón para volver al listado de indicadores -->
        <div class="text-end mb-3">
            <a href="/indicadores/gestionar/<%= cat_cod %>" class="btn btn-secondary">Volver a Indicadores</a>
        </div>

        <!-- Detalles del Indicador -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Detalle del Indicador</h5>
                <p><strong>Código:</strong>
                    <%= indicador.ind_cod %>
                </p>
                <p><strong>Nombre:</strong>
                    <%= indicador.ind_nombre %>
                </p>
                <p><strong>Responsable:</strong>
                    <%= indicador.MiembroUnidad.mie_nombres %>
                        <%= indicador.MiembroUnidad.mie_apellidos %>
                </p>
                <p><strong>Puntaje Total:</strong>
                    <%= indicador.ind_puntos %>
                </p>
                <% if (rangoSeleccionado) { %>
                    <p class="bg-light border-start border-primary border-4 p-2">
                        <strong>Puntaje Actual:</strong>
                        <span class="text-primary fw-bold">
                            <%= rangoSeleccionado.puntajeAsignado %>
                        </span>
                        (Rango Seleccionado: <%= rangoSeleccionado.descripcion_ran %>)
                    </p>
                    <% } else { %>
                        <p class="text-danger fw-bold">Sin rango seleccionado</p>
                        <% } %>
            </div>
        </div>

        <div class="text-end mb-3">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalRegistrarRango">Registrar Nuevo
                Rango</button>
        </div>

        <!-- Tabla de Rangos -->
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-primary">
                    <tr>
                        <th>Descripción</th>
                        <th>Valor</th>
                        <th>Seleccionado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% rangos.forEach(rango=> { %>
                        <tr>
                            <td>
                                <%= rango.descripcion_ran %>
                            </td>
                            <td>
                                <%= rango.valor_ran %> %
                            </td>
                            <td>
                                <%= rango.esta_seleccionado ? "Sí" : "No" %>
                            </td>
                            <td>
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#modalEditarRango" data-id_ran="<%= rango.id_ran %>"
                                    data-descripcion_ran="<%= rango.descripcion_ran %>"
                                    data-valor_ran="<%= rango.valor_ran %>"
                                    data-esta_seleccionado="<%= rango.esta_seleccionado %>">
                                    Editar
                                </button>
                                <form
                                    action="/indicadores/<%= cat_cod %>/rangos/eliminar/<%= indicador.ind_cod %>/<%= rango.id_ran %>"
                                    method="POST" class="d-inline"
                                    onsubmit="return confirm('¿Estás seguro de eliminar este rango?');">
                                    <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                                </form>
                                <% if (!rango.esta_seleccionado) { %>
                                    <form action="/indicadores/rangos/seleccionar/<%= rango.id_ran %>" method="POST"
                                        class="d-inline">
                                        <input type="hidden" name="cat_cod" value="<%= cat_cod %>">
                                        <button type="submit" class="btn btn-info btn-sm">Seleccionar</button>
                                    </form>
                                    <% } %>
                            </td>
                        </tr>
                        <% }); %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para Registrar Rango -->
    <div class="modal fade" id="modalRegistrarRango" tabindex="-1" aria-labelledby="modalRegistrarRangoLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRegistrarRangoLabel">Registrar Nuevo Rango</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/indicadores/rangos/registrar" method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="ind_cod" value="<%= indicador.ind_cod %>">
                        <input type="hidden" name="cat_cod" value="<%= cat_cod %>">
                        <div class="mb-3">
                            <label for="descripcion_ran" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion_ran" name="descripcion_ran"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="valor_ran" class="form-label">Valor (%)</label>
                            <input type="number" class="form-control" id="valor_ran" name="valor_ran" required>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="esta_seleccionado"
                                name="esta_seleccionado">
                            <label class="form-check-label" for="esta_seleccionado">Seleccionar como rango
                                actual</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Registrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Rango -->
    <div class="modal fade" id="modalEditarRango" tabindex="-1" aria-labelledby="modalEditarRangoLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarRangoLabel">Editar Rango</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/indicadores/rangos/editar" method="POST">
                    <div class="modal-body">
                        <input type="hidden" id="id_ran" name="id_ran">
                        <input type="hidden" name="ind_cod" value="<%= indicador.ind_cod %>">
                        <input type="hidden" name="cat_cod" value="<%= cat_cod %>">
                        <div class="mb-3">
                            <label for="descripcion_ran_editar" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion_ran_editar" name="descripcion_ran"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="valor_ran_editar" class="form-label">Valor (%)</label>
                            <input type="number" class="form-control" id="valor_ran_editar" name="valor_ran" required>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="esta_seleccionado_editar"
                                name="esta_seleccionado">
                            <label class="form-check-label" for="esta_seleccionado_editar">Seleccionar como rango
                                actual</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para cargar datos en el modal de editar -->
    <script>
        const modalEditarRango = document.getElementById("modalEditarRango");
        modalEditarRango.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const id_ran = button.getAttribute("data-id_ran");
            const descripcion_ran = button.getAttribute("data-descripcion_ran");
            const valor_ran = button.getAttribute("data-valor_ran");
            const esta_seleccionado = button.getAttribute("data-esta_seleccionado") === "true";

            document.getElementById("id_ran").value = id_ran;
            document.getElementById("descripcion_ran_editar").value = descripcion_ran;
            document.getElementById("valor_ran_editar").value = valor_ran;
            document.getElementById("esta_seleccionado_editar").checked = esta_seleccionado;
        });
    </script>
</body>

</html>